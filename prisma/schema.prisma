// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  MD
  SALES_HEAD
  TEAM_LEAD
  BD
  INSURANCE_HEAD
  PL_HEAD
  HR_HEAD
  FINANCE_HEAD
  ADMIN
  USER
}

enum Circle {
  North
  South
  East
  West
  Central
}

enum PipelineStage {
  SALES
  INSURANCE
  PL
  COMPLETED
  LOST
}

enum TargetType {
  BD
  TEAM
}

enum PeriodType {
  WEEK
  MONTH
}

enum TargetMetric {
  LEADS_CLOSED
  NET_PROFIT
  BILL_AMOUNT
  SURGERIES_DONE
}

enum BonusRuleType {
  PERCENT_ABOVE_TARGET
  FIXED_COUNT
}

enum InsuranceCaseStatus {
  IN_PROGRESS
  APPROVED
  REJECTED
  QUERY
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PunchDirection {
  IN
  OUT
}

enum PayrollComponentType {
  ALLOWANCE
  DEDUCTION
}

enum DocumentType {
  OFFER_LETTER
  APPRAISAL_LETTER
  EXPERIENCE_LETTER
  RELIEVING_LETTER
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  ACKNOWLEDGED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ApplicationStatus {
  PENDING
  SHORTLISTED
  REJECTED
  HIRED
}

enum KYPStatus {
  PENDING
  KYP_DETAILS_ADDED   // Insurance added hospitals, room types, TPA — BD can raise pre-auth
  PRE_AUTH_COMPLETE   // BD raised pre-auth, Insurance completed — actual pre-auth done
  FOLLOW_UP_COMPLETE
  COMPLETED
}

enum NotificationType {
  KYP_SUBMITTED
  PRE_AUTH_COMPLETE
  FOLLOW_UP_COMPLETE
  KYP_COMPLETED
  QUERY_RAISED
  QUERY_ANSWERED
  DISCHARGE_SHEET_CREATED
  PREAUTH_RAISED
  INITIATED
  DISCHARGED
  TASK_ASSIGNED
  TASK_DUE_SOON
  DUE_DATE_CHANGE_REQUESTED
  DUE_DATE_CHANGE_APPROVED
  DUE_DATE_CHANGE_REJECTED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum QueryStatus {
  PENDING
  ANSWERED
  RESOLVED
}

enum CaseStage {
  NEW_LEAD
  KYP_PENDING
  KYP_COMPLETE
  PREAUTH_RAISED
  PREAUTH_COMPLETE
  INITIATED
  ADMITTED
  DISCHARGED
  IPD_DONE
  PL_PENDING
  OUTSTANDING
}

enum PreAuthStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole
  teamId       String?
  team         Team?    @relation("TeamMembers", fields: [teamId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  createdLeads    Lead[]           @relation("LeadCreator")
  assignedLeads   Lead[]           @relation("LeadBD")
  updatedLeads    Lead[]           @relation("LeadUpdater")
  leadStageEvents LeadStageEvent[]
  createdTargets  Target[]         @relation("TargetCreator")
  salesHeadTeams  Team[]           @relation("SalesHead")
  insuranceCases  InsuranceCase[]
  plRecords       PLRecord[]
  employee        Employee?
  approvedLeaves  LeaveRequest[]   @relation("LeaveApprover")

  // Finance Ledger Relations
  createdLedgerEntries       LedgerEntry[]    @relation("LedgerCreator")
  approvedLedgerEntries      LedgerEntry[]    @relation("LedgerApprover")
  deletedLedgerEntries       LedgerEntry[]    @relation("LedgerDeleter")
  editRequestedLedgerEntries LedgerEntry[]    @relation("LedgerEditRequester")
  editApprovedLedgerEntries  LedgerEntry[]    @relation("LedgerEditApprover")
  ledgerAuditLogs            LedgerAuditLog[] @relation("LedgerAuditPerformer")
  
  // Finance Sales Relations
  createdSalesEntries        SalesEntry[]     @relation("SalesCreator")

  // Inventory Relations
  stockMovementsCreated      StockMovement[]      @relation("StockMovementCreator")
  purchasesCreated           PurchaseTransaction[] @relation("PurchaseCreator")
  issuesCreated              IssueTransaction[]   @relation("IssueCreator")
  issuesReceived             IssueTransaction[]   @relation("IssueRecipient")

  // KYP Relations
  kypSubmissions  KYPSubmission[]    @relation("KYPSubmitter")
  preAuthHandled  PreAuthorization[] @relation("PreAuthHandler")
  followUpUpdated PatientFollowUp[]  @relation("FollowUpUpdater")
  queriesRaised   InsuranceQuery[]   @relation("QueryRaiser")
  queriesAnswered InsuranceQuery[]   @relation("QueryAnswerer")
  notifications   Notification[]

  // Discharge Sheet Relations
  dischargeSheetsCreated DischargeSheet[] @relation("DischargeSheetCreator")

  // Outstanding Relations
  outstandingCasesHandled OutstandingCase[] @relation("OutstandingHandler")

  // Department Head Relations
  departmentHeadOf Department[] @relation("DepartmentHead")

  // Case Workflow Relations
  preAuthsRaised     PreAuthorization[] @relation("PreAuthRaiser")
  pdfsCreated        PreAuthPDF[]       @relation("PDFCreator")
  admissionsInitiated AdmissionRecord[]  @relation("AdmissionInitiator")
  caseStageChanges   CaseStageHistory[]  @relation("CaseStageChanger")

  // Task Management Relations
  tasksAssigned       Task[]               @relation("TaskAssignee")
  tasksCreated        Task[]               @relation("TaskCreator")
  taskApprovalsRequested TaskDueDateApproval[]
  workLogs            WorkLog[]
  mdTaskTeamsOwned    MDTaskTeam[]         @relation("MDTaskTeamOwner")
  mdWatchlistOwned    MDWatchlistEmployee[] @relation("MDWatchlistOwner")

  @@index([email])
  @@index([role])
  @@index([teamId])
}

model Team {
  id          String   @id @default(cuid())
  name        String
  circle      Circle
  salesHeadId String
  salesHead   User     @relation("SalesHead", fields: [salesHeadId], references: [id])
  members     User[]   @relation("TeamMembers")
  targets     Target[] @relation
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([salesHeadId])
  @@index([circle])
}

model Lead {
  id              String        @id @default(cuid())
  leadRef         String        @unique
  patientName     String
  age             Int
  sex             String
  phoneNumber     String
  alternateNumber String?
  attendantName   String?
  bdId            String
  bd              User          @relation("LeadBD", fields: [bdId], references: [id])
  status          String
  pipelineStage   PipelineStage @default(SALES)
  caseStage       CaseStage     @default(NEW_LEAD)
  circle          Circle
  city            String
  category        String?
  treatment       String?
  anesthesia      String?
  quantityGrade   String?
  surgeonName     String?
  surgeonType     String?
  hospitalName    String
  modeOfPayment   String?
  discount        Float         @default(0)
  copay           Float         @default(0)
  deduction       Float         @default(0)
  settledTotal    Float         @default(0)
  billAmount      Float         @default(0)
  insuranceName   String?
  tpa             String?
  sumInsured      Float?
  roomRent        Float?
  icu             Float?
  capping         Float?
  arrivalDate     DateTime?
  arrivalTime     String?
  surgeryDate     DateTime?
  operationTime   String?
  implantType     String?
  implantAmount   Float         @default(0)
  instrument      String?
  consumables     String?
  createdById     String
  createdBy       User          @relation("LeadCreator", fields: [createdById], references: [id])
  createdDate     DateTime      @default(now())
  updatedById     String
  updatedBy       User          @relation("LeadUpdater", fields: [updatedById], references: [id])
  updatedDate     DateTime      @updatedAt
  remarks         String?
  source          String?
  campaignName    String?
  bdeName         String?
  conversionDate  DateTime?
  mediendProfit   Float         @default(0)
  hospitalShare   Float         @default(0)
  doctorShare     Float         @default(0)
  othersShare     Float         @default(0)
  netProfit       Float         @default(0)
  ticketSize      Float         @default(0)

  // Additional MySQL fields
  month              String?
  leadEntryDate      DateTime?
  patientEmail       String?
  whatsapp           String?
  address            String?
  docUpload          String?
  diseaseDetails     String?
  followUpDate       DateTime?
  subStatus          Int?
  opdHospital        String?
  opdDrName          String?
  opdContactNo       String?
  opdCharges         Int       @default(0)
  opdScheduleDate    DateTime?
  opdMeeting         Int?
  ipdAdmissionDate   DateTime?
  ipdHospital        String?
  ipdDrName          String?
  ipdContactNo       String?
  ipdTotalPayment    Int       @default(0)
  ipdDetails         String?
  paymentDetails     Int?
  attendantContactNo String?
  waFormat           String?
  leadSource         Int?
  whatsappMessage    String?
  notification       Boolean   @default(false)
  cityOption         String?
  emailSent          Boolean   @default(false)
  smsSent            Boolean   @default(false)
  whatsappSent       Boolean   @default(false)
  website            String?
  description        String?
  refId              String?
  duplCount          Int       @default(0)
  aes                Boolean   @default(false)
  profession         String?
  qr                 String?
  removeRemarks      Boolean   @default(false)
  adId               String?
  campaignId         String?
  formId             String?
  teamLeadId         Int?
  remarksId          String?

  // Relations
  stageEvents     LeadStageEvent[]
  insuranceCase   InsuranceCase?
  plRecord        PLRecord?
  kypSubmission   KYPSubmission?
  dischargeSheet  DischargeSheet?
  outstandingCase OutstandingCase?
  admissionRecord AdmissionRecord?
  caseStageHistory CaseStageHistory[]

  @@index([bdId])
  @@index([status])
  @@index([pipelineStage])
  @@index([caseStage])
  @@index([circle])
  @@index([city])
  @@index([hospitalName])
  @@index([treatment])
  @@index([source])
  @@index([createdDate])
  @@index([conversionDate])
  @@index([surgeryDate])
  @@index([leadEntryDate])
  @@index([followUpDate])
}

model LeadStageEvent {
  id          String        @id @default(cuid())
  leadId      String
  lead        Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  fromStage   PipelineStage
  toStage     PipelineStage
  changedById String
  changedBy   User          @relation(fields: [changedById], references: [id])
  changedAt   DateTime      @default(now())
  note        String?

  @@index([leadId])
  @@index([changedAt])
}

model Target {
  id              String       @id @default(cuid())
  targetType      TargetType
  targetForId     String // Can be User.id or Team.id depending on targetType
  teamId          String?
  team            Team?        @relation(fields: [teamId], references: [id])
  periodType      PeriodType
  periodStartDate DateTime
  periodEndDate   DateTime
  metric          TargetMetric
  targetValue     Float
  createdById     String
  createdBy       User         @relation("TargetCreator", fields: [createdById], references: [id])
  bonusRules      BonusRule[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([targetType, targetForId])
  @@index([periodStartDate, periodEndDate])
  @@index([teamId])
}

model BonusRule {
  id              String        @id @default(cuid())
  targetId        String
  target          Target        @relation(fields: [targetId], references: [id], onDelete: Cascade)
  ruleType        BonusRuleType
  thresholdValue  Float
  bonusAmount     Float?
  bonusPercentage Float?
  capAmount       Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([targetId])
}

model InsuranceCase {
  id             String              @id @default(cuid())
  leadId         String              @unique
  lead           Lead                @relation(fields: [leadId], references: [id], onDelete: Cascade)
  caseStatus     InsuranceCaseStatus @default(IN_PROGRESS)
  approvalAmount Float?
  tpaRemarks     String?
  submittedAt    DateTime            @default(now())
  approvedAt     DateTime?
  handledById    String?
  handledBy      User?               @relation(fields: [handledById], references: [id])
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([leadId])
  @@index([caseStatus])
  @@index([submittedAt])
}

model PLRecord {
  id     String @id @default(cuid())
  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Core Identification
  month              DateTime? // Reporting month
  surgeryDate        DateTime? // Date of surgery
  status             String? // Case status
  paymentType        String? // Payment mode
  approvedOrCash     String? // Approved / Cash
  paymentCollectedAt String? // Collection source

  // People & Ownership
  managerRole  String? // ATL / TL / ACM / CM / SCM
  managerName  String? // Person name
  bdmName      String? // Business Development Manager
  patientName  String? // Patient full name
  patientPhone String? // Phone number
  doctorName   String? // Treating doctor
  hospitalName String? // Hospital

  // Case Details
  category   String? // Cosmetic / Medical
  treatment  String? // Procedure
  circle     String? // City / region
  leadSource String? // Source of lead

  // Financials (Raw)
  totalAmount       Float @default(0) // Total case value
  billAmount        Float @default(0) // Hospital bill
  cashPaidByPatient Float @default(0) // Direct patient cash
  cashOrDedPaid     Float @default(0) // Cash / deduction
  referralAmount    Float @default(0) // Referral payout
  cabCharges        Float @default(0) // Logistics cost
  implantCost       Float @default(0) // Implant
  dcCharges         Float @default(0) // D&C
  doctorCharges     Float @default(0) // Doctor fee

  // Revenue Split
  hospitalSharePct    Float? // % (DECIMAL(5,2))
  hospitalShareAmount Float  @default(0) // Amount
  mediendSharePct     Float? // % (DECIMAL(5,2))
  mediendShareAmount  Float  @default(0) // Gross share
  mediendNetProfit    Float  @default(0) // Final profit (renamed from finalProfit)

  // Legacy fields (keeping for backward compatibility)
  finalProfit          Float   @default(0) // Alias for mediendNetProfit
  hospitalPayoutStatus String? // e.g., "PENDING", "PAID", "PARTIAL"
  doctorPayoutStatus   String? // e.g., "PENDING", "PAID", "PARTIAL"
  mediendInvoiceStatus String? // e.g., "PENDING", "SENT", "PAID"

  // Meta
  remarks     String?   @db.Text // Free text
  closedAt    DateTime?
  handledById String?
  handledBy   User?     @relation(fields: [handledById], references: [id])

  // Relations
  dischargeSheet DischargeSheet? @relation("DischargeSheetPLRecord") // Optional link to discharge sheet

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([closedAt])
  @@index([month])
  @@index([surgeryDate])
  @@index([status])
}

model IncomingLead {
  id         String   @id @default(cuid())
  source     String?
  payload    Json
  status     String   @default("PENDING") // PENDING, PROCESSED, FAILED
  receivedAt DateTime @default(now())

  @@index([status])
  @@index([receivedAt])
}

// HRMS Models

model Department {
  id          String   @id @default(cuid())
  name        String
  description String?
  headId      String?
  head        User?    @relation("DepartmentHead", fields: [headId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  employees      Employee[]
  teams          DepartmentTeam[]
  supportTickets SupportTicket[]

  @@index([name])
  @@index([headId])
}

model DepartmentTeam {
  id          String   @id @default(cuid())
  name        String
  departmentId String
  department  Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  teamLeadId  String?  @unique // Employee ID who is the team lead (one employee can only lead one team)
  teamLead    Employee? @relation("DepartmentTeamLead", fields: [teamLeadId], references: [id])
  members     Employee[] @relation("DepartmentTeamMembers")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([departmentId])
  @@index([teamLeadId])
}

model Employee {
  id           String      @id @default(cuid())
  userId       String      @unique
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeCode String      @unique
  joinDate     DateTime?
  salary       Float?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  teamId       String?     // DepartmentTeam ID
  team         DepartmentTeam? @relation("DepartmentTeamMembers", fields: [teamId], references: [id])
  teamLeadOf   DepartmentTeam? @relation("DepartmentTeamLead") // Employee is team lead of this team
  dateOfBirth  DateTime?
  aadharNumber String?
  panNumber    String?
  aadharDocUrl String?
  panDocUrl    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  attendanceLogs       AttendanceLog[]
  leaveRequests        LeaveRequest[]
  leaveBalances        LeaveBalance[]
  payrollRecords       PayrollRecord[]
  documents            EmployeeDocument[]
  feedbacks            Feedback[]
  mdAppointments       MDAppointment[]
  mentalHealthRequests MentalHealthRequest[]
  supportTickets       SupportTicket[]
  incrementRequests    IncrementRequest[]
  ijpApplications      IJPApplication[]
  mdTaskTeamMemberships MDTaskTeamMember[]
  mdWatchlistMemberships MDWatchlistEmployee[]

  @@index([userId])
  @@index([employeeCode])
  @@index([departmentId])
  @@index([teamId])
}

model AttendanceLog {
  id             String         @id @default(cuid())
  employeeId     String
  employee       Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  logDate        DateTime
  punchDirection PunchDirection
  temperature    Float          @default(0)
  serialNumber   String?
  createdAt      DateTime       @default(now())

  @@unique([employeeId, logDate, punchDirection])
  @@index([employeeId])
  @@index([logDate])
  @@index([punchDirection])
}

model LeaveTypeMaster {
  id        String   @id @default(cuid())
  name      String   @unique
  maxDays   Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveRequests LeaveRequest[]
  leaveBalances LeaveBalance[]

  @@index([name])
  @@index([isActive])
}

model LeaveRequest {
  id           String             @id @default(cuid())
  employeeId   String
  employee     Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId  String
  leaveType    LeaveTypeMaster    @relation(fields: [leaveTypeId], references: [id])
  startDate    DateTime
  endDate      DateTime
  days         Int
  reason       String?
  status       LeaveRequestStatus @default(PENDING)
  approvedById String?
  approvedBy   User?              @relation("LeaveApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?
  remarks      String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@index([leaveTypeId])
}

model LeaveBalance {
  id          String          @id @default(cuid())
  employeeId  String
  employee    Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId String
  leaveType   LeaveTypeMaster @relation(fields: [leaveTypeId], references: [id])
  allocated   Int             @default(0)
  used        Int             @default(0)
  remaining   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([employeeId, leaveTypeId])
  @@index([employeeId])
  @@index([leaveTypeId])
}

model PayrollRecord {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  month       Int
  year        Int
  disbursedAt DateTime
  basicSalary Float
  grossSalary Float
  netSalary   Float
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  components PayrollComponent[]

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
}

model PayrollComponent {
  id              String               @id @default(cuid())
  payrollRecordId String
  payrollRecord   PayrollRecord        @relation(fields: [payrollRecordId], references: [id], onDelete: Cascade)
  componentType   PayrollComponentType
  name            String
  amount          Float
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([payrollRecordId])
  @@index([componentType])
}

// Employee Documents (Offer Letter, Appraisal, etc.)
model EmployeeDocument {
  id           String       @id @default(cuid())
  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  documentType DocumentType
  documentUrl  String?
  metadata     Json?
  generatedAt  DateTime     @default(now())
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([employeeId])
  @@index([documentType])
}

// Feedback 360 - Employee submits, HR reviews
model Feedback {
  id         String         @id @default(cuid())
  employeeId String
  employee   Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  content    String
  status     FeedbackStatus @default(PENDING)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Anonymous Messages to MD - No user info stored
model AnonymousMessage {
  id        String   @id @default(cuid())
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([createdAt])
}

// MD Appointment Requests
model MDAppointment {
  id            String            @id @default(cuid())
  employeeId    String
  employee      Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  preferredDate DateTime?
  reason        String
  status        AppointmentStatus @default(PENDING)
  remarks       String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Mental Health Support Requests (48hr SLA)
model MentalHealthRequest {
  id          String        @id @default(cuid())
  employeeId  String
  employee    Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reason      String?
  status      RequestStatus @default(PENDING)
  hrResponse  String?
  respondedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Help Support Tickets (48hr SLA)
model SupportTicket {
  id           String         @id @default(cuid())
  employeeId   String
  employee     Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  departmentId String
  department   Department     @relation(fields: [departmentId], references: [id])
  subject      String
  description  String
  priority     TicketPriority @default(MEDIUM)
  status       TicketStatus   @default(OPEN)
  response     String?
  respondedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([employeeId])
  @@index([departmentId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// Increment Requests
model IncrementRequest {
  id                 String        @id @default(cuid())
  employeeId         String
  employee           Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  currentSalary      Float
  requestedAmount    Float?
  reason             String
  achievements       String?
  documents          Json?
  status             RequestStatus @default(PENDING)
  approvalPercentage Float?
  hrRemarks          String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Internal Job Postings
model InternalJobPosting {
  id           String   @id @default(cuid())
  title        String
  description  String
  department   String?
  requirements String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  applications IJPApplication[]

  @@index([isActive])
  @@index([createdAt])
}

// IJP Applications / Referrals
model IJPApplication {
  id             String             @id @default(cuid())
  postingId      String
  posting        InternalJobPosting @relation(fields: [postingId], references: [id], onDelete: Cascade)
  referredById   String
  referrer       Employee           @relation(fields: [referredById], references: [id], onDelete: Cascade)
  candidateName  String
  candidateEmail String?
  candidatePhone String?
  resumeUrl      String
  description    String?
  documents      Json?
  status         ApplicationStatus  @default(PENDING)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([postingId])
  @@index([referredById])
  @@index([status])
  @@index([createdAt])
}

// ==========================================
// Finance Ledger Module
// ==========================================

enum PartyType {
  BUYER
  SELLER
  VENDOR
  CLIENT
  SUPPLIER
  OTHER
}

enum TransactionType {
  CREDIT
  DEBIT
  SELF_TRANSFER
}

enum LedgerStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FinancePaymentType {
  EXPENSE
  NON_EXPENSE
  RECEIPT
}

enum LedgerAuditAction {
  CREATED
  UPDATED
  APPROVED
  REJECTED
  DELETED
  EDIT_REQUESTED
  EDIT_APPROVED
  EDIT_REJECTED
}

// Party Master - Centralized list of all parties
model PartyMaster {
  id           String    @id @default(cuid())
  name         String
  partyType    PartyType
  contactName  String?
  contactEmail String?
  contactPhone String?
  gstNumber    String?
  panNumber    String?
  address      String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  ledgerEntries LedgerEntry[]
  itemsSupplied ItemMaster[]
  purchases     PurchaseTransaction[]

  @@index([name])
  @@index([partyType])
  @@index([isActive])
}

// Head Master - Categories for transactions
model HeadMaster {
  id          String   @id @default(cuid())
  name        String   @unique
  department  String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ledgerEntries LedgerEntry[]

  @@index([name])
  @@index([isActive])
}

// Project Master - For sales/revenue categorization
model ProjectMaster {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  salesEntries SalesEntry[]

  @@index([name])
  @@index([isActive])
}

// Payment Type Master - Expense classification
model PaymentTypeMaster {
  id          String             @id @default(cuid())
  name        String             @unique
  paymentType FinancePaymentType
  description String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  ledgerEntries LedgerEntry[]

  @@index([paymentType])
  @@index([isActive])
}

// Payment Mode Master - Bank accounts/cash with balances
model PaymentModeMaster {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?
  openingBalance Float    @default(0)
  currentBalance Float    @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ledgerEntries LedgerEntry[]
  fromTransfers LedgerEntry[] @relation("FromPaymentMode")
  toTransfers   LedgerEntry[] @relation("ToPaymentMode")

  @@index([name])
  @@index([isActive])
}

// Ledger Entry - Core transaction record
model LedgerEntry {
  id                 String            @id @default(cuid())
  serialNumber       String            @unique
  transactionType    TransactionType
  transactionDate    DateTime          @default(now())
  partyId            String?
  party              PartyMaster?      @relation(fields: [partyId], references: [id])
  description        String
  headId             String?
  head               HeadMaster?       @relation(fields: [headId], references: [id])
  paymentTypeId      String?
  paymentType        PaymentTypeMaster? @relation(fields: [paymentTypeId], references: [id])
  paymentAmount      Float? // For DEBIT entries (Total = componentA + componentB)
  componentA         Float? // For DEBIT entries - Main expense (more relevant)
  componentB         Float? // For DEBIT entries - Claimable amount (18%, 5%, 0%, etc.)
  receivedAmount     Float? // For CREDIT entries
  paymentModeId      String? // For CREDIT/DEBIT entries (or "from" for SELF_TRANSFER)
  paymentMode        PaymentModeMaster? @relation(fields: [paymentModeId], references: [id])
  // Self transfer fields
  fromPaymentModeId  String? // Source payment mode for SELF_TRANSFER
  fromPaymentMode    PaymentModeMaster? @relation("FromPaymentMode", fields: [fromPaymentModeId], references: [id])
  toPaymentModeId    String? // Destination payment mode for SELF_TRANSFER
  toPaymentMode      PaymentModeMaster? @relation("ToPaymentMode", fields: [toPaymentModeId], references: [id])
  transferAmount     Float? // Transfer amount for SELF_TRANSFER
  openingBalance     Float // Snapshot at time of transaction
  currentBalance     Float // Balance after transaction (calculated)
  status             LedgerStatus      @default(PENDING)
  rejectionReason    String?
  // Soft delete fields
  isDeleted          Boolean           @default(false)
  deletedAt          DateTime?
  deletedById        String?
  deletedBy          User?             @relation("LedgerDeleter", fields: [deletedById], references: [id])
  deletedReason      String?
  // Edit request fields
  editRequestStatus  LedgerStatus? // PENDING, APPROVED, or REJECTED for edit requests
  editRequestReason  String? // Why edit is needed (required when requesting)
  editRequestData    Json? // Requested changes
  editRequestedById  String?
  editRequestedBy    User?             @relation("LedgerEditRequester", fields: [editRequestedById], references: [id])
  editRequestedAt    DateTime?
  editApprovalReason String? // Why approval was given/rejected (required when approving/rejecting)
  editApprovedById   String?
  editApprovedBy     User?             @relation("LedgerEditApprover", fields: [editApprovedById], references: [id])
  editApprovedAt     DateTime?
  editCount          Int               @default(0) // Number of completed edit cycles (max 5)
  createdById        String
  createdBy          User              @relation("LedgerCreator", fields: [createdById], references: [id])
  approvedById       String?
  approvedBy         User?             @relation("LedgerApprover", fields: [approvedById], references: [id])
  approvedAt         DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  auditLogs LedgerAuditLog[]

  @@index([serialNumber])
  @@index([transactionType])
  @@index([transactionDate])
  @@index([partyId])
  @@index([headId])
  @@index([paymentModeId])
  @@index([fromPaymentModeId])
  @@index([toPaymentModeId])
  @@index([status])
  @@index([createdById])
  @@index([isDeleted])
  @@index([editRequestStatus])
}

// Ledger Audit Log - Tracks all changes and approvals
model LedgerAuditLog {
  id            String            @id @default(cuid())
  ledgerEntryId String
  ledgerEntry   LedgerEntry       @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)
  action        LedgerAuditAction
  previousData  Json?
  newData       Json?
  reason        String?
  performedById String
  performedBy   User              @relation("LedgerAuditPerformer", fields: [performedById], references: [id])
  performedAt   DateTime          @default(now())

  @@index([ledgerEntryId])
  @@index([action])
  @@index([performedAt])
}

// Sales Entry - Booked sales/revenue (does not affect bank balances)
model SalesEntry {
  id              String         @id @default(cuid())
  serialNumber    String         @unique   // Format: SL-0001
  transactionDate DateTime       @default(now())
  projectId       String
  project         ProjectMaster  @relation(fields: [projectId], references: [id])
  description     String
  amount          Float          // Booked sale amount
  notes           String?
  isDeleted       Boolean        @default(false)
  deletedAt       DateTime?
  createdById     String
  createdBy       User           @relation("SalesCreator", fields: [createdById], references: [id])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([transactionDate])
  @@index([projectId])
  @@index([isDeleted])
}

// ==========================================
// Inventory Management Module
// ==========================================

enum LocationType {
  WAREHOUSE
  SUB_WAREHOUSE
}

enum StockMovementType {
  PURCHASE
  ISSUE
  ADJUSTMENT
}

enum InventoryTransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

// Location Master - Hierarchical warehouse structure
model LocationMaster {
  id          String        @id @default(cuid())
  name        String
  code        String        @unique
  type        LocationType
  parentId    String?
  parent      LocationMaster? @relation("LocationHierarchy", fields: [parentId], references: [id])
  children    LocationMaster[] @relation("LocationHierarchy")
  description String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  items       ItemMaster[]
  purchases   PurchaseTransaction[]
  issues      IssueTransaction[]
  stockMovements StockMovement[]

  @@index([code])
  @@index([type])
  @@index([parentId])
  @@index([isActive])
}

// Item Master - Inventory items
model ItemMaster {
  id                String   @id @default(cuid())
  itemCode          String   @unique
  name              String
  price             Float
  unit              String
  supplierId        String
  supplier          PartyMaster @relation(fields: [supplierId], references: [id])
  locationId        String
  location          LocationMaster @relation(fields: [locationId], references: [id])
  minimumStockLevel Float
  maximumStockLevel Float
  description       String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  purchases         PurchaseTransaction[]
  issues            IssueTransaction[]
  stockMovements    StockMovement[]

  @@index([itemCode])
  @@index([name])
  @@index([supplierId])
  @@index([locationId])
  @@index([isActive])
}

// Stock Movement - Track stock changes per item per location
model StockMovement {
  id            String            @id @default(cuid())
  itemId        String
  item          ItemMaster         @relation(fields: [itemId], references: [id])
  locationId    String
  location      LocationMaster     @relation(fields: [locationId], references: [id])
  quantity      Float
  movementType  StockMovementType
  referenceId   String
  referenceType StockMovementType
  createdAt     DateTime          @default(now())
  createdById   String
  createdBy     User              @relation("StockMovementCreator", fields: [createdById], references: [id])

  @@index([itemId])
  @@index([locationId])
  @@index([referenceId])
  @@index([createdAt])
}

// Purchase Transaction - Item purchases
model PurchaseTransaction {
  id            String                    @id @default(cuid())
  purchaseNumber String                    @unique
  itemId        String
  item          ItemMaster                 @relation(fields: [itemId], references: [id])
  supplierId    String
  supplier      PartyMaster                @relation(fields: [supplierId], references: [id])
  locationId    String
  location      LocationMaster             @relation(fields: [locationId], references: [id])
  quantity      Float
  unitPrice     Float
  totalPrice    Float
  purchaseDate  DateTime                   @default(now())
  description   String?
  status        InventoryTransactionStatus @default(PENDING)
  createdAt     DateTime                  @default(now())
  createdById   String
  createdBy     User                       @relation("PurchaseCreator", fields: [createdById], references: [id])
  updatedAt     DateTime                  @updatedAt

  @@index([purchaseNumber])
  @@index([itemId])
  @@index([supplierId])
  @@index([locationId])
  @@index([purchaseDate])
  @@index([status])
}

// Issue Transaction - Item issues to employees
model IssueTransaction {
  id            String                    @id @default(cuid())
  issueNumber   String                    @unique
  itemId        String
  item          ItemMaster                 @relation(fields: [itemId], references: [id])
  locationId    String
  location      LocationMaster             @relation(fields: [locationId], references: [id])
  quantity      Float
  unitPrice     Float
  totalPrice    Float
  issuedToId    String
  issuedTo      User                       @relation("IssueRecipient", fields: [issuedToId], references: [id])
  issueDate     DateTime                   @default(now())
  description   String?
  status        InventoryTransactionStatus @default(PENDING)
  createdAt     DateTime                  @default(now())
  createdById   String
  createdBy     User                       @relation("IssueCreator", fields: [createdById], references: [id])
  updatedAt     DateTime                  @updatedAt

  @@index([issueNumber])
  @@index([itemId])
  @@index([locationId])
  @@index([issuedToId])
  @@index([issueDate])
  @@index([status])
}

// Lead Remark - Stores remarks from MySQL lead_remarks table
model LeadRemark {
  id         String   @id @default(cuid())
  leadRef    String // MySQL lead.id as string reference
  remarks    String   @db.Text
  updateBy   Int? // MySQL user ID reference
  updateDate DateTime
  ip         String?
  leadStatus Int? // MySQL status ID
  createdAt  DateTime @default(now())

  @@index([leadRef])
  @@index([updateDate])
}

// Sync State - Tracks MySQL sync progress
model SyncState {
  id             String   @id @default(cuid())
  sourceType     String   @unique @default("mysql_leads") // For future extensibility
  lastSyncedDate DateTime
  lastSyncedId   Int? // Last MySQL lead.id processed
  recordsCount   Int      @default(0)
  lastRunAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ==========================================
// KYP (Know Your Patient) Module
// ==========================================

model KYPSubmission {
  id     String @id @default(cuid())
  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Form fields (all optional)
  aadhar        String?
  pan           String?
  insuranceCard String?
  disease       String?
  location      String? // City name
  remark        String?

  // File URLs (stored in S3)
  aadharFileUrl        String?
  panFileUrl           String?
  insuranceCardFileUrl String?
  otherFiles           Json? // Array of {name, url} objects

  // Status tracking
  status        KYPStatus @default(PENDING)
  submittedById String
  submittedBy   User      @relation("KYPSubmitter", fields: [submittedById], references: [id])
  submittedAt   DateTime  @default(now())

  // Pre-authorization (filled by Insurance)
  preAuthData PreAuthorization?

  // Patient follow-up (filled by Sales)
  followUpData PatientFollowUp?

  // Discharge sheet (optional link)
  dischargeSheet DischargeSheet? @relation("DischargeSheetKYP")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([status])
  @@index([submittedAt])
}

model PreAuthorization {
  id              String        @id @default(cuid())
  kypSubmissionId String        @unique
  kypSubmission   KYPSubmission @relation(fields: [kypSubmissionId], references: [id], onDelete: Cascade)

  // All fields as strings (per requirement)
  sumInsured             String?
  roomRent               String?
  capping                String?
  copay                  String?
  icu                    String?
  hospitalNameSuggestion String?
  insurance              String?
  tpa                    String?

  // Insurance: multiple hospitals and room types (JSON)
  hospitalSuggestions Json?   // string[] — multiple suggested hospitals
  roomTypes           Json?   // { name: string, rent: string }[] — multiple room types with rent limits

  // BD Pre-Auth Request fields (selection from Insurance suggestions)
  requestedHospitalName String?
  requestedRoomType     String?
  diseaseDescription    String? @db.Text
  diseaseImages         Json?   // Array of {name, url}
  preAuthRaisedAt       DateTime?
  preAuthRaisedById     String?
  preAuthRaisedBy       User?   @relation("PreAuthRaiser", fields: [preAuthRaisedById], references: [id])

  handledById String?
  handledBy   User?    @relation("PreAuthHandler", fields: [handledById], references: [id])
  handledAt   DateTime?

  // Approval/Rejection
  approvalStatus PreAuthStatus @default(PENDING)
  rejectionReason String?      @db.Text
  approvedAt      DateTime?
  rejectedAt      DateTime?

  // Q&A Queries
  queries InsuranceQuery[]

  // PDF generation
  pdfVersions PreAuthPDF[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kypSubmissionId])
  @@index([preAuthRaisedById])
}

model PatientFollowUp {
  id              String        @id @default(cuid())
  kypSubmissionId String        @unique
  kypSubmission   KYPSubmission @relation(fields: [kypSubmissionId], references: [id], onDelete: Cascade)

  admissionDate DateTime?
  surgeryDate   DateTime?
  prescription  String?
  report        String?
  hospitalName  String?
  doctorName    String?

  // File URLs
  prescriptionFileUrl String?
  reportFileUrl       String?

  updatedById String
  updatedBy   User     @relation("FollowUpUpdater", fields: [updatedById], references: [id])
  updatedAt   DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([kypSubmissionId])
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String
  link      String? // URL to relevant page
  relatedId String? // ID of related entity (leadId, kypSubmissionId, etc)

  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ==========================================
// Insurance Query (Q&A Flow)
// ==========================================

model InsuranceQuery {
  id                 String           @id @default(cuid())
  preAuthorizationId String
  preAuthorization   PreAuthorization @relation(fields: [preAuthorizationId], references: [id], onDelete: Cascade)

  question String      @db.Text // Question from Insurance
  answer   String?     @db.Text // Answer from BD
  status   QueryStatus @default(PENDING)

  raisedById   String // Insurance user who raised the query
  raisedBy     User    @relation("QueryRaiser", fields: [raisedById], references: [id])
  answeredById String? // BD user who answered
  answeredBy   User?   @relation("QueryAnswerer", fields: [answeredById], references: [id])

  raisedAt   DateTime  @default(now())
  answeredAt DateTime?
  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([preAuthorizationId])
  @@index([status])
  @@index([raisedAt])
}

// ==========================================
// Pre-Auth PDF
// ==========================================

model PreAuthPDF {
  id                 String           @id @default(cuid())
  preAuthorizationId String
  preAuthorization   PreAuthorization @relation(fields: [preAuthorizationId], references: [id], onDelete: Cascade)
  
  version       Int
  pdfUrl        String
  recipients    Json?    // Array of recipients
  sentAt        DateTime?
  createdById   String
  createdBy     User     @relation("PDFCreator", fields: [createdById], references: [id])
  createdAt     DateTime @default(now())
  
  @@index([preAuthorizationId])
}

// ==========================================
// Admission Record
// ==========================================

model AdmissionRecord {
  id       String @id @default(cuid())
  leadId   String @unique
  lead     Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  admissionDate     DateTime
  admissionTime     String?
  admittingHospital String
  expectedSurgeryDate DateTime?
  notes             String? @db.Text
  
  initiatedById String
  initiatedBy   User   @relation("AdmissionInitiator", fields: [initiatedById], references: [id])
  initiatedAt   DateTime @default(now())
  
  @@index([leadId])
}

// ==========================================
// Case Stage History
// ==========================================

model CaseStageHistory {
  id        String    @id @default(cuid())
  leadId    String
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  fromStage CaseStage?
  toStage   CaseStage
  changedById String
  changedBy User      @relation("CaseStageChanger", fields: [changedById], references: [id])
  changedAt DateTime  @default(now())
  note      String?   @db.Text
  
  @@index([leadId])
  @@index([changedAt])
}

// ==========================================
// Discharge Sheet
// ==========================================

model DischargeSheet {
  id              String         @id @default(cuid())
  leadId          String         @unique
  lead            Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  kypSubmissionId String?        @unique // Optional link to KYP
  kypSubmission   KYPSubmission? @relation("DischargeSheetKYP", fields: [kypSubmissionId], references: [id])

  // Core Identification
  month              DateTime? // Reporting month
  dischargeDate      DateTime? // Date of discharge
  surgeryDate        DateTime? // Date of surgery
  status             String? // Case status
  paymentType        String? // Payment mode
  approvedOrCash     String? // Approved / Cash
  paymentCollectedAt String? // Collection source

  // People & Ownership
  managerRole  String? // ATL / TL / ACM / CM / SCM
  managerName  String? // Person name
  bdmName      String? // Business Development Manager
  patientName  String? // Patient full name
  patientPhone String? // Phone number
  doctorName   String? // Treating doctor
  hospitalName String? // Hospital

  // Case Details
  category   String? // Cosmetic / Medical
  treatment  String? // Procedure
  circle     String? // City / region
  leadSource String? // Source of lead

  // Financials (Raw)
  totalAmount       Float @default(0) // Total case value
  billAmount        Float @default(0) // Hospital bill
  cashPaidByPatient Float @default(0) // Direct patient cash
  cashOrDedPaid     Float @default(0) // Cash / deduction
  referralAmount    Float @default(0) // Referral payout
  cabCharges        Float @default(0) // Logistics cost
  implantCost       Float @default(0) // Implant
  dcCharges         Float @default(0) // D&C
  doctorCharges     Float @default(0) // Doctor fee

  // Revenue Split
  hospitalSharePct    Float? // % (DECIMAL(5,2))
  hospitalShareAmount Float  @default(0) // Amount
  mediendSharePct     Float? // % (DECIMAL(5,2))
  mediendShareAmount  Float  @default(0) // Gross share
  mediendNetProfit    Float  @default(0) // Final profit

  // Meta
  remarks String? @db.Text // Free text

  // Relations
  createdById String // Insurance user who created
  createdBy   User      @relation("DischargeSheetCreator", fields: [createdById], references: [id])
  plRecordId  String?   @unique // Optional link to PNL record
  plRecord    PLRecord? @relation("DischargeSheetPLRecord", fields: [plRecordId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([kypSubmissionId])
  @@index([month])
  @@index([surgeryDate])
  @@index([status])
}

// ==========================================
// Outstanding Cases
// ==========================================

model OutstandingCase {
  id     String @id @default(cuid())
  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Core Identification
  srNo            Int? // Excel serial
  month           DateTime? // Reporting month
  dos             DateTime? // Date of service
  status          String? // Case status
  paymentReceived Boolean   @default(false) // YES / NO

  // People & Case
  managerName  String? // Manager
  bdmName      String? // BDM
  patientName  String? // Patient
  treatment    String? // Procedure
  hospitalName String? // Hospital

  // Financials
  billAmount        Float @default(0) // Total bill
  settlementAmount  Float @default(0) // Settled amount
  cashPaidByPatient Float @default(0) // Patient cash
  overallAmount     Float @default(0) // Total
  implantCost       Float @default(0) // Implant
  dciCost           Float @default(0) // DCI

  // Revenue Split
  hospitalSharePct    Float? // % (DECIMAL(5,2))
  hospitalShareAmount Float  @default(0) // Amount
  mediendSharePct     Float? // % (DECIMAL(5,2))
  mediendShareAmount  Float  @default(0) // Amount

  // Outstanding Tracking
  outstandingDays Int? // Days pending (calculated)
  remarks         String? @db.Text // Internal notes
  remark2         String? @db.Text // Follow-ups

  // Relations
  handledById String?
  handledBy   User?   @relation("OutstandingHandler", fields: [handledById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([month])
  @@index([dos])
  @@index([status])
  @@index([paymentReceived])
}

// ==========================================
// Task Management Module
// ==========================================

model Task {
  id          String       @id @default(cuid())
  title       String
  description String?      @db.Text
  dueDate     DateTime?
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)

  // Ownership
  assigneeId  String
  assignee    User         @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User         @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)

  // Calendar display
  startTime   DateTime?
  endTime     DateTime?
  allDay      Boolean      @default(true)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  approvals   TaskDueDateApproval[]

  @@index([assigneeId])
  @@index([createdById])
  @@index([status])
  @@index([dueDate])
}

model TaskDueDateApproval {
  id             String             @id @default(cuid())
  taskId         String
  task           Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  requestedById  String
  requestedBy    User               @relation(fields: [requestedById], references: [id], onDelete: Cascade)
  oldDueDate     DateTime?
  newDueDate     DateTime?
  status         TaskApprovalStatus @default(PENDING)
  createdAt      DateTime           @default(now())

  @@index([taskId])
  @@index([requestedById])
  @@index([status])
}

// MD (admin) task teams: saved sets of employees for quick task assignment
model MDTaskTeam {
  id        String   @id @default(cuid())
  name      String
  ownerId   String
  owner     User     @relation("MDTaskTeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members   MDTaskTeamMember[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model MDTaskTeamMember {
  id        String     @id @default(cuid())
  teamId    String
  team      MDTaskTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  employeeId String
  employee  Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([teamId, employeeId])
  @@index([teamId])
  @@index([employeeId])
}

// MD Watchlist: Personal list of employees to monitor
model MDWatchlistEmployee {
  id         String   @id @default(cuid())
  ownerId    String
  owner      User     @relation("MDWatchlistOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([ownerId, employeeId])
  @@index([ownerId])
  @@index([employeeId])
}

model WorkLog {
  id            String   @id @default(cuid())
  employeeId    String
  employee      User     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  logDate       DateTime // The date of the work
  intervalStart Int      // 9, 12, or 15 (hour)
  intervalEnd   Int      // 12, 15, or 18 (hour)
  description   String   @db.Text
  createdAt     DateTime @default(now())

  @@unique([employeeId, logDate, intervalStart])
  @@index([employeeId])
  @@index([logDate])
}
