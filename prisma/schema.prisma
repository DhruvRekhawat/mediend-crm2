// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  MD
  SALES_HEAD
  TEAM_LEAD
  BD
  INSURANCE_HEAD
  PL_HEAD
  HR_HEAD
  ADMIN
}

enum Circle {
  North
  South
  East
  West
  Central
}

enum PipelineStage {
  SALES
  INSURANCE
  PL
  COMPLETED
  LOST
}

enum TargetType {
  BD
  TEAM
}

enum PeriodType {
  WEEK
  MONTH
}

enum TargetMetric {
  LEADS_CLOSED
  NET_PROFIT
  BILL_AMOUNT
  SURGERIES_DONE
}

enum BonusRuleType {
  PERCENT_ABOVE_TARGET
  FIXED_COUNT
}

enum InsuranceCaseStatus {
  IN_PROGRESS
  APPROVED
  REJECTED
  QUERY
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PunchDirection {
  IN
  OUT
}

enum PayrollComponentType {
  ALLOWANCE
  DEDUCTION
}

enum DocumentType {
  OFFER_LETTER
  APPRAISAL_LETTER
  EXPERIENCE_LETTER
  RELIEVING_LETTER
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  ACKNOWLEDGED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ApplicationStatus {
  PENDING
  SHORTLISTED
  REJECTED
  HIRED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String
  role          UserRole
  teamId        String?
  team          Team?    @relation("TeamMembers", fields: [teamId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  createdLeads          Lead[]              @relation("LeadCreator")
  assignedLeads         Lead[]              @relation("LeadBD")
  updatedLeads           Lead[]              @relation("LeadUpdater")
  leadStageEvents       LeadStageEvent[]
  createdTargets        Target[]            @relation("TargetCreator")
  salesHeadTeams        Team[]              @relation("SalesHead")
  insuranceCases        InsuranceCase[]
  plRecords             PLRecord[]
  employee              Employee?
  approvedLeaves        LeaveRequest[] @relation("LeaveApprover")

  @@index([email])
  @@index([role])
  @@index([teamId])
}

model Team {
  id          String   @id @default(cuid())
  name        String
  circle      Circle
  salesHeadId String
  salesHead   User     @relation("SalesHead", fields: [salesHeadId], references: [id])
  members     User[]   @relation("TeamMembers")
  targets     Target[] @relation
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([salesHeadId])
  @@index([circle])
}

model Lead {
  id                String        @id @default(cuid())
  leadRef           String        @unique
  patientName       String
  age               Int
  sex               String
  phoneNumber       String
  alternateNumber   String?
  attendantName     String?
  bdId              String
  bd                User          @relation("LeadBD", fields: [bdId], references: [id])
  status            String
  pipelineStage     PipelineStage @default(SALES)
  circle            Circle
  city              String
  category          String?
  treatment         String
  anesthesia        String?
  quantityGrade     String?
  surgeonName       String?
  surgeonType       String?
  hospitalName      String
  modeOfPayment     String?
  discount          Float         @default(0)
  copay             Float         @default(0)
  deduction         Float         @default(0)
  settledTotal      Float         @default(0)
  billAmount        Float         @default(0)
  insuranceName     String?
  tpa               String?
  sumInsured        Float?
  roomRent          Float?
  icu               Float?
  capping            Float?
  arrivalDate       DateTime?
  arrivalTime       String?
  surgeryDate       DateTime?
  operationTime     String?
  implantType       String?
  implantAmount     Float         @default(0)
  instrument        String?
  consumables       String?
  createdById       String
  createdBy         User          @relation("LeadCreator", fields: [createdById], references: [id])
  createdDate       DateTime      @default(now())
  updatedById       String
  updatedBy         User          @relation("LeadUpdater", fields: [updatedById], references: [id])
  updatedDate       DateTime      @updatedAt
  remarks           String?
  source            String?
  campaignName      String?
  bdeName           String?
  conversionDate    DateTime?
  mediendProfit     Float         @default(0)
  hospitalShare     Float         @default(0)
  doctorShare       Float         @default(0)
  othersShare       Float         @default(0)
  netProfit         Float         @default(0)
  ticketSize        Float         @default(0)

  // Relations
  stageEvents       LeadStageEvent[]
  insuranceCase     InsuranceCase?
  plRecord          PLRecord?

  @@index([bdId])
  @@index([status])
  @@index([pipelineStage])
  @@index([circle])
  @@index([city])
  @@index([hospitalName])
  @@index([treatment])
  @@index([source])
  @@index([createdDate])
  @@index([conversionDate])
  @@index([surgeryDate])
}

model LeadStageEvent {
  id          String        @id @default(cuid())
  leadId      String
  lead        Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  fromStage   PipelineStage
  toStage     PipelineStage
  changedById String
  changedBy   User          @relation(fields: [changedById], references: [id])
  changedAt   DateTime      @default(now())
  note        String?

  @@index([leadId])
  @@index([changedAt])
}

model Target {
  id            String        @id @default(cuid())
  targetType    TargetType
  targetForId   String // Can be User.id or Team.id depending on targetType
  teamId        String?
  team          Team?         @relation(fields: [teamId], references: [id])
  periodType    PeriodType
  periodStartDate DateTime
  periodEndDate   DateTime
  metric        TargetMetric
  targetValue   Float
  createdById   String
  createdBy     User          @relation("TargetCreator", fields: [createdById], references: [id])
  bonusRules    BonusRule[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([targetType, targetForId])
  @@index([periodStartDate, periodEndDate])
  @@index([teamId])
}

model BonusRule {
  id              String          @id @default(cuid())
  targetId        String
  target          Target          @relation(fields: [targetId], references: [id], onDelete: Cascade)
  ruleType        BonusRuleType
  thresholdValue  Float
  bonusAmount     Float?
  bonusPercentage Float?
  capAmount       Float?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([targetId])
}

model InsuranceCase {
  id            String              @id @default(cuid())
  leadId        String              @unique
  lead          Lead                @relation(fields: [leadId], references: [id], onDelete: Cascade)
  caseStatus    InsuranceCaseStatus @default(IN_PROGRESS)
  approvalAmount Float?
  tpaRemarks    String?
  submittedAt   DateTime            @default(now())
  approvedAt    DateTime?
  handledById   String?
  handledBy     User?               @relation(fields: [handledById], references: [id])
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([leadId])
  @@index([caseStatus])
  @@index([submittedAt])
}

model PLRecord {
  id                  String    @id @default(cuid())
  leadId              String    @unique
  lead                Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  finalProfit         Float     @default(0)
  hospitalPayoutStatus String?  // e.g., "PENDING", "PAID", "PARTIAL"
  doctorPayoutStatus   String?   // e.g., "PENDING", "PAID", "PARTIAL"
  mediendInvoiceStatus String?  // e.g., "PENDING", "SENT", "PAID"
  closedAt            DateTime?
  handledById         String?
  handledBy           User?     @relation(fields: [handledById], references: [id])
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([leadId])
  @@index([closedAt])
}


model IncomingLead {
  id          String   @id @default(cuid())
  source      String?
  payload     Json
  status      String   @default("PENDING") // PENDING, PROCESSED, FAILED
  receivedAt  DateTime @default(now())

  @@index([status])
  @@index([receivedAt])
}

// HRMS Models

model Department {
  id          String     @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  employees      Employee[]
  supportTickets SupportTicket[]

  @@index([name])
}

model Employee {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeCode  String    @unique
  joinDate      DateTime?
  salary        Float?
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  dateOfBirth   DateTime?
  aadharNumber  String?
  panNumber     String?
  aadharDocUrl  String?
  panDocUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  attendanceLogs       AttendanceLog[]
  leaveRequests        LeaveRequest[]
  leaveBalances        LeaveBalance[]
  payrollRecords       PayrollRecord[]
  documents            EmployeeDocument[]
  feedbacks            Feedback[]
  mdAppointments       MDAppointment[]
  mentalHealthRequests MentalHealthRequest[]
  supportTickets       SupportTicket[]
  incrementRequests    IncrementRequest[]
  ijpApplications      IJPApplication[]

  @@index([userId])
  @@index([employeeCode])
  @@index([departmentId])
}

model AttendanceLog {
  id              String         @id @default(cuid())
  employeeId      String
  employee        Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  logDate         DateTime
  punchDirection  PunchDirection
  temperature     Float          @default(0)
  serialNumber    String?
  createdAt       DateTime       @default(now())

  @@unique([employeeId, logDate, punchDirection])
  @@index([employeeId])
  @@index([logDate])
  @@index([punchDirection])
}

model LeaveTypeMaster {
  id        String   @id @default(cuid())
  name      String   @unique
  maxDays   Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveRequests LeaveRequest[]
  leaveBalances LeaveBalance[]

  @@index([name])
  @@index([isActive])
}

model LeaveRequest {
  id            String            @id @default(cuid())
  employeeId    String
  employee      Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId   String
  leaveType     LeaveTypeMaster   @relation(fields: [leaveTypeId], references: [id])
  startDate     DateTime
  endDate       DateTime
  days          Int
  reason        String?
  status        LeaveRequestStatus @default(PENDING)
  approvedById  String?
  approvedBy    User?             @relation("LeaveApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  remarks       String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@index([leaveTypeId])
}

model LeaveBalance {
  id          String         @id @default(cuid())
  employeeId  String
  employee    Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId String
  leaveType   LeaveTypeMaster @relation(fields: [leaveTypeId], references: [id])
  allocated   Int            @default(0)
  used        Int            @default(0)
  remaining   Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([employeeId, leaveTypeId])
  @@index([employeeId])
  @@index([leaveTypeId])
}

model PayrollRecord {
  id            String            @id @default(cuid())
  employeeId    String
  employee      Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  month         Int
  year          Int
  disbursedAt   DateTime
  basicSalary   Float
  grossSalary   Float
  netSalary     Float
  status        String            @default("PENDING")
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  components    PayrollComponent[]

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
}

model PayrollComponent {
  id              String              @id @default(cuid())
  payrollRecordId String
  payrollRecord   PayrollRecord       @relation(fields: [payrollRecordId], references: [id], onDelete: Cascade)
  componentType   PayrollComponentType
  name            String
  amount          Float
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([payrollRecordId])
  @@index([componentType])
}

// Employee Documents (Offer Letter, Appraisal, etc.)
model EmployeeDocument {
  id           String       @id @default(cuid())
  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  documentType DocumentType
  documentUrl  String?
  metadata     Json?
  generatedAt  DateTime     @default(now())
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([employeeId])
  @@index([documentType])
}

// Feedback 360 - Employee submits, HR reviews
model Feedback {
  id         String         @id @default(cuid())
  employeeId String
  employee   Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  content    String
  status     FeedbackStatus @default(PENDING)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Anonymous Messages to MD - No user info stored
model AnonymousMessage {
  id        String   @id @default(cuid())
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([createdAt])
}

// MD Appointment Requests
model MDAppointment {
  id            String            @id @default(cuid())
  employeeId    String
  employee      Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  preferredDate DateTime?
  reason        String
  status        AppointmentStatus @default(PENDING)
  remarks       String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Mental Health Support Requests (48hr SLA)
model MentalHealthRequest {
  id          String        @id @default(cuid())
  employeeId  String
  employee    Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reason      String?
  status      RequestStatus @default(PENDING)
  hrResponse  String?
  respondedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Help Support Tickets (48hr SLA)
model SupportTicket {
  id           String         @id @default(cuid())
  employeeId   String
  employee     Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  departmentId String
  department   Department     @relation(fields: [departmentId], references: [id])
  subject      String
  description  String
  priority     TicketPriority @default(MEDIUM)
  status       TicketStatus   @default(OPEN)
  response     String?
  respondedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([employeeId])
  @@index([departmentId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// Increment Requests
model IncrementRequest {
  id                 String        @id @default(cuid())
  employeeId         String
  employee           Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  currentSalary      Float
  requestedAmount    Float?
  reason             String
  achievements       String?
  documents          Json?
  status             RequestStatus @default(PENDING)
  approvalPercentage Float?
  hrRemarks          String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// Internal Job Postings
model InternalJobPosting {
  id           String           @id @default(cuid())
  title        String
  description  String
  department   String?
  requirements String?
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  applications IJPApplication[]

  @@index([isActive])
  @@index([createdAt])
}

// IJP Applications / Referrals
model IJPApplication {
  id            String             @id @default(cuid())
  postingId     String
  posting       InternalJobPosting @relation(fields: [postingId], references: [id], onDelete: Cascade)
  referredById  String
  referrer      Employee           @relation(fields: [referredById], references: [id], onDelete: Cascade)
  candidateName String
  candidateEmail String?
  candidatePhone String?
  resumeUrl     String
  description   String?
  documents     Json?
  status        ApplicationStatus  @default(PENDING)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([postingId])
  @@index([referredById])
  @@index([status])
  @@index([createdAt])
}
